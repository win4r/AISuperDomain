<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Aila.MainPage"
             Title="AIè¶…å…ƒåŸŸ">

    <!-- <AbsoluteLayout> -->
    <!--     <Grid x:Name="_grid" -->
    <!--           AbsoluteLayout.LayoutBounds="0, 0, 1, 1" -->
    <!--           AbsoluteLayout.LayoutFlags="All"> -->
    <!--         <Grid.ColumnDefinitions> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--             <ColumnDefinition Width="*" /> -->
    <!--         </Grid.ColumnDefinitions> -->
    <!--         <Grid.RowDefinitions> -->
    <!--             <RowDefinition Height="*" /> -->
    <!--             <RowDefinition Height="Auto" /> -->
    <!--         </Grid.RowDefinitions> -->
    <!-- -->
    <!--         ~1~ Editor å æ®å‰10åˆ— @1@ -->
    <!--         <Editor  -->
    <!--             x:Name="_editor" -->
    <!--             Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="10" -->
    <!--                 Placeholder="ğŸ‘‰ğŸ‘‰ğŸ‘‰Enter your question here..." -->
    <!--                 VerticalOptions="Start" -->
    <!--                 FontSize="18" -->
    <!--                 AutoSize="TextChanges"/> -->
    <!-- -->
    <!--         ~1~ Submit Button å æ®ç¬¬11åˆ— @1@ -->
    <!--         <Button -->
    <!--             x:Name="SubmitBtn" -->
    <!--             Grid.Row="1" Grid.Column="10" Text="â¡ Submit" -->
    <!--                 HeightRequest="50" -->
    <!--                 VerticalOptions="End" -->
    <!--                 Clicked="OnSubmitClicked" /> -->
    <!-- -->
    <!--         ~1~ Switch Button å æ®ç¬¬12åˆ— @1@ -->
    <!--         <Button  -->
    <!--             x:Name="SwitchBtn" -->
    <!--             Grid.Row="1" Grid.Column="11" Text="â†© Switch" -->
    <!--                 HeightRequest="50" -->
    <!--                 VerticalOptions="End" -->
    <!--                 Clicked="OnSwitchClicked" /> -->
    <!-- -->
    <!--     </Grid> -->
    <!-- </AbsoluteLayout> -->

    
</ContentPage>



    private Dictionary<WebView, (string Url, int Row, int Column, int ColumnSpan)> _webViewsInfo = new();

    private Button SubmitBtn;

    private Button SwitchBtn;



  private void UpdateToolbarItemsForCurrentGroup()
    {
        // é¦–å…ˆæ¸…é™¤ç°æœ‰çš„ ToolbarItems
        ToolbarItems.Clear();

        // åŠ¨æ€è®¡ç®—åŸºäº viewsCount çš„å½“å‰ç»„çš„ WebView èŒƒå›´
        int groupSize = _viewsCount; // ä½¿ç”¨å½“å‰çš„viewsCountç¡®å®šæ¯ç»„çš„å¤§å°
        int start = _currentGroupIndex * groupSize;
        int end = Math.Min(start + groupSize, _configuration.CurrentAi.Count);

        //
        // // åˆ›å»ºå¹¶æ·»åŠ æ–°çš„ToolbarItem
        // var toolbarItem = new ToolbarItem
        // {
        //     Text = "\ud83c\udfe0 Home", // æ˜¾ç¤ºåç§°
        // };
        //
        // toolbarItem.Clicked += (sender, e) =>
        // {
        //     // è¿™é‡Œæ·»åŠ ä½ å¸Œæœ›åœ¨ç‚¹å‡»æ—¶æ‰§è¡Œçš„ä»£ç 
        //     RestoreWebViewsLayout(); // ä¾‹å¦‚ï¼Œè°ƒç”¨ RestoreWebViewsLayout æ–¹æ³•
        // };
        //
        // ToolbarItems.Add(toolbarItem);

        // ä¸ºå½“å‰ç»„çš„æ¯ä¸ª WebView æ·»åŠ  ToolbarItem
        for (int i = start; i < end; i++)
        {
            var currentAi = _configuration.CurrentAi[i];
            var aiConfig = _configuration.AiConfig.FirstOrDefault(ai => ai.Id == currentAi.Id);
            if (aiConfig != null)
            {
                // åˆ›å»ºå¹¶æ·»åŠ æ–°çš„ToolbarItem
                ToolbarItems.Add(new ToolbarItem
                {
                    Text = "\ud83d\udfe2" + aiConfig.Name, // æ˜¾ç¤ºAIé…ç½®çš„åç§°
                    Command = new Command(() => ExecuteLoadWebViewCommand(aiConfig.Url))
                });
            }
        }
    }
    
    
    
    
    
    
      // æ–°å¢æ–¹æ³•ï¼šæ¢å¤ WebView æ§ä»¶åˆ°å…¶å­˜å‚¨çš„å¸ƒå±€ä½ç½®
        private void RestoreWebViewsLayout()
        {
            _editor.IsVisible = true;
            SubmitBtn.IsVisible = true;
            SwitchBtn.IsVisible = true;
    
            foreach (var item in _webViewsInfo)
            {
                WebView webView = item.Key;
    
                webView.IsVisible = true;
    
                var layoutInfo = item.Value;
    
                Grid.SetRow(webView, layoutInfo.Row);
                Grid.SetRowSpan(webView, 1);
    
                Grid.SetColumn(webView, layoutInfo.Column);
                Grid.SetColumnSpan(webView, layoutInfo.ColumnSpan);
            }
        }
        
        
        
        
        
        
          private void ShowPopupWithCollectionView()
            {
                // åˆ›å»º CollectionView å¹¶è®¾ç½®æ•°æ®æº
                var collectionView = new CollectionView
                {
                    ItemsSource = _configuration.Prompts,
                    SelectionMode = SelectionMode.Single,
        
                    ItemTemplate = new DataTemplate(() =>
                    {
                        var frame = new Frame
                        {
                            BackgroundColor = Colors.White,
        
                            Padding = 10,
                            CornerRadius = 5,
                            // BorderColor = Colors.LightGray,
                            Content = new Label
                            {
                                TextColor = Colors.Black,
                                VerticalOptions = LayoutOptions.Center,
                                HorizontalOptions = LayoutOptions.Start
                            }
                        };
        
                        frame.Content.SetBinding(Label.TextProperty, nameof(Prompts.Title));
        
                        return frame;
                    }),
                };
        
                // åˆ›å»º Frame ç”¨äºåŒ…è£… collectionView
                var frameForCollectionView = new Frame
                {
                    Content = collectionView,
                    Padding = 0 // æ ¹æ®éœ€è¦è°ƒæ•´
                };
        
                collectionView.SelectionChanged += (sender, e) =>
                {
                    if (e.CurrentSelection.Count > 0)
                    {
                        var selectedItem = e.CurrentSelection[0] as Prompts;
                        if (selectedItem != null)
                        {
                            // æ ¹æ® ID æŸ¥è¯¢å¯¹åº”çš„ Prompt
                            var prompt = _configuration.Prompts.FirstOrDefault(p => p.Id == selectedItem.Id)?.Prompt;
                            if (!string.IsNullOrEmpty(prompt))
                            {
                                // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦ä»¥ "/" å¼€å¤´
                                if (_editor.Text.StartsWith("/"))
                                {
                                    // ç§»é™¤ç¬¬ä¸€ä¸ªå­—ç¬¦ "/"
                                    _editor.Text = _editor.Text.Substring(1);
        
                                    // é˜²æ­¢å…‰æ ‡ç§»åŠ¨åˆ°æ–‡æœ¬å¼€å¤´
                                    _editor.CursorPosition = _editor.Text.Length;
                                }
        
                                _editor.Text = prompt;
        
                                if (_grid.Children.Contains(frameForCollectionView))
                                {
                                    _grid.Children.Remove(frameForCollectionView);
                                }
                            }
        
                            collectionView.SelectedItem = null; // æ¸…é™¤é€‰æ‹©
                        }
                    }
                };
        
        
                // å°† frame æ·»åŠ åˆ° Grid çš„ç¬¬ä¸€è¡Œå’Œç¬¬ä¸€åˆ—
                Grid.SetRow(frameForCollectionView, 0);
                Grid.SetColumn(frameForCollectionView, 0);
                Grid.SetColumnSpan(frameForCollectionView, 3);
        
                _grid.Children.Add(frameForCollectionView);
            }
            
            
            // å®šä¹‰å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•
                private void ExecuteLoadWebViewCommand(string url)
                {
                    _editor.IsVisible = false;
                    SubmitBtn.IsVisible = false;
                    SwitchBtn.IsVisible = false;
            
                    _webViewsInfo.Clear();
            
                    if (this.Content is View contentView)
                    {
                        FindVisibleWebViewsAndInfo(contentView);
                    }
            
                    foreach (var item in _webViewsInfo)
                    {
                        if (item.Value.Url.ToString() == url)
                        {
                            WebView webView = item.Key;
                            // æ›´æ–° WebView å¸ƒå±€
                            Grid.SetRow(webView, 0);
                            Grid.SetRowSpan(webView, 2);
                            Grid.SetColumn(webView, 0);
                            Grid.SetColumnSpan(webView, 12);
                        }
                        else
                        {
                            WebView webView = item.Key;
                            webView.IsVisible = false;
                        }
                    }
                }


 private void FindVisibleWebViewsAndInfo(View view)
    {
        if (view is WebView webView && webView.IsVisible)
        {
            string url = string.Empty;
            // ç¡®å®š WebView.Source çš„ç±»å‹å¹¶ç›¸åº”åœ°è·å– URL
            if (webView.Source is UrlWebViewSource urlSource)
            {
                url = urlSource.Url; // è·å–å®é™…çš„ URL å­—ç¬¦ä¸²
            }

            var row = Grid.GetRow(webView);
            var column = Grid.GetColumn(webView);
            var columnSpan = Grid.GetColumnSpan(webView);

            // å°† WebView åŠå…¶ä¿¡æ¯æ·»åŠ åˆ°å­—å…¸ä¸­
            _webViewsInfo.Add(webView, (Url: url, Row: row, Column: column, ColumnSpan: columnSpan));
        }

        // å¦‚æœå½“å‰è§†å›¾æ˜¯å¸ƒå±€å®¹å™¨ï¼Œéå†å…¶å­è§†å›¾
        if (view is Layout layout)
        {
            foreach (var child in layout.Children)
            {
                if (child is View childView)
                {
                    FindVisibleWebViewsAndInfo(childView);
                }
            }
        }
    }


        AddItemToGrid(_editor, 1, 0, 10);

        AddButtonToGrid(SubmitBtn,"\u27a2 Submit", OnSubmitClicked, 1, 10, 1, "Click to Send your question to AI");
        AddButtonToGrid(SwitchBtn,"\u21b9 Switch", OnSwitchClicked, 1, 11, 1, "Click to Switch AI");



    private void AddButtonToGrid(Button button,string text, EventHandler onClicked, int row, int column, int columnSpan, string toolTip)
    {
         button = new Button
        {
            
            Text = text,
            HeightRequest = 50,
            HorizontalOptions = LayoutOptions.Fill,
            VerticalOptions = LayoutOptions.End
        };
        ToolTipProperties.SetText(button, toolTip);

        button.Clicked += onClicked;
        AddItemToGrid(button, row, column, columnSpan);
    }

















